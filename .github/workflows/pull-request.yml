name: Pull Request CI/CD

on:
  pull_request:
    branches:
      - main

# Cancel in-progress runs when a new workflow on the same PR is triggered
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  # Job 1: Code Formatting and Static Analysis
  format-code:
    name: Code Formatting & PHPStan
    runs-on: ubuntu-latest

    env:
      DATABASE_URL: postgresql://localhost:5432/dummy?serverVersion=16&charset=utf8

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: ctype, iconv, pdo, pgsql
          coverage: none
          tools: composer:v2

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache composer dependencies
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Run PHP CS Fixer (dry-run)
        run: vendor/bin/php-cs-fixer fix --dry-run --diff --verbose

      - name: Run PHPStan
        run: composer phpstan

  # Job 2: PHP Unit Tests
  unit-tests:
    name: Unit Tests (PHP)
    runs-on: ubuntu-latest
    needs: format-code

    env:
      APP_ENV: test
      DATABASE_URL: postgresql://flashcards_user:flashcards_pass@localhost:5432/flashcards_test?serverVersion=16&charset=utf8

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: flashcards_test
          POSTGRES_USER: flashcards_user
          POSTGRES_PASSWORD: flashcards_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Override Docker hostnames for CI
        run: |
          sed -i 's|flashcards-postgres|localhost|g' .env .env.test
          sed -i 's|flashcards-mailpit|localhost|g' .env .env.test

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: ctype, iconv, pdo, pgsql
          coverage: xdebug
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache composer dependencies
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install Node dependencies
        run: npm ci

      - name: Setup test database
        run: |
          php bin/console doctrine:database:create --env=test --if-not-exists
          php bin/console doctrine:migrations:migrate --env=test --no-interaction

      - name: Run PHP unit tests with coverage
        run: vendor/bin/phpunit --coverage-clover coverage-php.xml

      #- name: Run JS unit tests with coverage
      #  run: npm run test:coverage

      - name: Upload PHP coverage artifact
        uses: actions/upload-artifact@v6
        with:
          name: coverage-php
          path: coverage-php.xml
          retention-days: 7

#      - name: Upload JS coverage artifact
#        uses: actions/upload-artifact@v6
#        with:
#          name: coverage-js
#          path: coverage/
#          retention-days: 7

  # Job 3: E2E Tests with Playwright
  e2e-tests:
    name: E2E Tests (Playwright)
    runs-on: ubuntu-latest
    needs: format-code
    environment: integration

    env:
      APP_ENV: test
      APP_SECRET: ${{ secrets.APP_SECRET }}
      DATABASE_URL: postgresql://flashcards_user:flashcards_pass@localhost:5432/flashcards_test?serverVersion=16&charset=utf8
      MAILER_DSN: ${{ secrets.MAILER_DSN }}
      MESSENGER_TRANSPORT_DSN: doctrine://default?auto_setup=0
      OPENROUTER_API_KEY: ${{ secrets.OPENROUTER_API_KEY }}
      OPENROUTER_API_URL: https://openrouter.ai/api/v1/chat/completions
      OPENROUTER_DEFAULT_MODEL: xiaomi/mimo-v2-flash:free
      OPENROUTER_DEFAULT_TIMEOUT: 60
      BASE_URL: http://localhost:8000

    services:
      postgres:
        image: postgres:16-alpine
        env:
          POSTGRES_DB: flashcards_test
          POSTGRES_USER: flashcards_user
          POSTGRES_PASSWORD: flashcards_pass
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Override Docker hostnames for CI
        run: |
          sed -i 's|flashcards-postgres|localhost|g' .env .env.test
          sed -i 's|flashcards-mailpit|localhost|g' .env .env.test
          echo "=== .env ===" && cat .env
          echo "=== .env.test ===" && cat .env.test

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.3'
          extensions: ctype, iconv, pdo, pgsql
          coverage: none
          tools: composer:v2

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'
          cache: 'npm'

      - name: Get composer cache directory
        id: composer-cache
        run: echo "dir=$(composer config cache-files-dir)" >> $GITHUB_OUTPUT

      - name: Cache composer dependencies
        uses: actions/cache@v5
        with:
          path: ${{ steps.composer-cache.outputs.dir }}
          key: ${{ runner.os }}-composer-${{ hashFiles('**/composer.lock') }}
          restore-keys: ${{ runner.os }}-composer-

      - name: Install PHP dependencies
        run: composer install --prefer-dist --no-progress --no-interaction

      - name: Install Node dependencies
        run: npm ci

      - name: Install Playwright browsers
        run: npm run playwright:install

      - name: Build Tailwind CSS
        run: php bin/console tailwind:build

      - name: Setup test database
        run: |
          php bin/console doctrine:database:create --env=test --if-not-exists
          php bin/console doctrine:migrations:migrate --env=test --no-interaction

      - name: Start PHP built-in server
        run: |
          APP_ENV=test DATABASE_URL="${DATABASE_URL}" php -S localhost:8000 -t public/ > /dev/null 2>&1 &
          echo $! > server.pid

      - name: Wait for server to be ready
        run: |
          timeout 30 bash -c 'until curl -s http://localhost:8000 > /dev/null; do sleep 1; done'

      - name: Run E2E tests
        run: npm run test:e2e

      - name: Stop PHP server
        if: always()
        run: |
          if [ -f server.pid ]; then
            kill $(cat server.pid) || true
            rm server.pid
          fi

      - name: Upload Playwright report
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-report
          path: var/playwright-report/
          retention-days: 7

      - name: Upload E2E test results
        if: always()
        uses: actions/upload-artifact@v6
        with:
          name: playwright-results
          path: test-results/
          retention-days: 7

  # Job 4: Status Comment
  status-comment:
    name: Post PR Status Comment
    runs-on: ubuntu-latest
    needs: [format-code, unit-tests, e2e-tests]
    if: always()
    permissions:
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v6

      - name: Determine overall status
        id: status
        run: |
          FORMAT_STATUS="${{ needs.format-code.result }}"
          UNIT_STATUS="${{ needs.unit-tests.result }}"
          E2E_STATUS="${{ needs.e2e-tests.result }}"

          if [[ "$FORMAT_STATUS" == "success" && "$UNIT_STATUS" == "success" && "$E2E_STATUS" == "success" ]]; then
            echo "result=✅ All checks passed!" >> $GITHUB_OUTPUT
            echo "emoji=✅" >> $GITHUB_OUTPUT
          else
            echo "result=❌ Some checks failed" >> $GITHUB_OUTPUT
            echo "emoji=❌" >> $GITHUB_OUTPUT
          fi

          echo "format=$FORMAT_STATUS" >> $GITHUB_OUTPUT
          echo "unit=$UNIT_STATUS" >> $GITHUB_OUTPUT
          echo "e2e=$E2E_STATUS" >> $GITHUB_OUTPUT

      - name: Create status comment
        uses: marocchino/sticky-pull-request-comment@v2
        with:
          header: ci-status
          message: |
            ## ${{ steps.status.outputs.emoji }} CI Pipeline Status

            | Job | Status |
            |-----|--------|
            | Code Formatting & PHPStan | ${{ steps.status.outputs.format == 'success' && '✅ Passed' || '❌ Failed' }} |
            | Unit Tests (PHP + JS) | ${{ steps.status.outputs.unit == 'success' && '✅ Passed' || '❌ Failed' }} |
            | E2E Tests (Playwright) | ${{ steps.status.outputs.e2e == 'success' && '✅ Passed' || '❌ Failed' }} |

            **Overall Result:** ${{ steps.status.outputs.result }}

            ---
            *Workflow run: [${{ github.run_id }}](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})*
